<dom-module id="rk-events-core">
  <template>
    <style>

    </style>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'rk-events-core',

        properties: {
          url: {
            type: String,
          },
          username: {
            type: String,
          },
          password: {
            type: String,
          },
          room: {
            type: String,
          },
          messages: {
            type: Array,
            notify: true,

          }
        },

        addMessages: function (messages) {
          if (!Array.isArray(this.messages)) {
            console.log(messages)
            this.messages = messages;
            console.log(this.messages);
          } else {

            messages.forEach((message) => {
              this.push('messages', message);
            });
          }
        },

        connect: function () {
          return new Promise((resolve, reject) => {
            var connection = new Asteroid({
              endpoint: this.url+ 'websocket',
              SocketConstructor: WebSocket
            });

            connection.ddp.on('connected', () => {
              console.log('Connected!')
              this.connection = connection;

              resolve();
            });

            connection.ddp.on('changed', function (message) {
              console.log(message);
            });

            connection.ddp.on('added', function (message) {
              console.log(message);
              const coll = connection.collections.get(message.collection);
              console.log(JSON.stringify(coll));
            });

            connection.ddp.on("ready", function (message) {
              console.log(message)
            });

          });
        },

        login: function () {
          return new Promise((resolve, reject) => {

            this.connection.loginWithPassword({email: this.username, password: this.password}).then(result => {
              console.log(result);

              resolve();
            }).catch(err => {
              console.log(err)
              reject();
            });
          });
        },

        subscribe: function () {
          var roomId = this.roomId;

          //connection.sub('settings');
          this.connection.subscribe('stream-notify-all');
          this.connection.subscribe('stream-notify-room');
          this.connection.subscribe('stream-notify-user');
          this.connection.subscribe('scopedRoles', 'Users');
          this.connection.subscribe('scopedRoles', 'Subscriptions');
          this.connection.subscribe('roles');
          //connection.sub('permissions');
          this.connection.subscribe('integrations');
          this.connection.subscribe('oauthApps');
          this.connection.subscribe('subscription');
          this.connection.subscribe('userData');
          //connection.sub('activeUsers');
          this.connection.subscribe('meteor_autoupdate_clientVersions');
          this.connection.subscribe('stream-messages', null);

          this.connection.subscribe('room', 'cgeneral');
        },

        loadHistory: function (roomId) {
          return new Promise((resolve, reject) => {

            this.connection.call('loadHistory', roomId, null, 100, new Date()).then(results => {
              resolve(results.messages);
            });

          });
        },

        ready: function() {
          this.connect().then(() => {

            this.login().then(() => {
              console.log('Successfully Logged In');
              this.subscribe();
              this.loadHistory(this.room).then((messages) => {
                this.addMessages(messages);
              }).catch(err => console.log(err));

            }).catch((err) => console.log('Error Logging In', err));
          }).catch((err) => console.log('Error Connecting', err));
        }
      });
    })();
  </script>
</dom-module>
